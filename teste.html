<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Carregamento de Caminhões</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* Estilos existentes... */
        .codigo-funcionario {
            font-weight: bold;
            color: #007bff;
        }
        .time-normal { color: green; }
        .time-warning { color: orange; }
        .time-critical { color: red; }
        .progress-bar-tempo { height: 10px; }
        .doca-container {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .doca-ocupada {
            background-color: #92ebad;
            border-color: #ffffff;
        }
        .doca-tempo-verde { background-color: #d4edda; }   /* acima de 40 min */
        .doca-tempo-amarelo { background-color: #fff3cd; } /* entre 20 e 40 min */
        .doca-tempo-vermelho { background-color: #f8d7da; }/* 20 min ou menos */
        .doca-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        #card-title-text-centerrr{
            padding-bottom: 45px;
            color: #005abb;
        }
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 300px;
            margin-top: 50px;
        }
        .podium-step {
            width: 100px;
            text-align: center;
            position: relative;
            margin: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .podium-step .name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .podium-step .medal-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .podium-step .base {
            width: 100%;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            position: relative;
        }
        .podium-step.gold .base { height: 200px; background-color: #ffda6a; border-color: #fec500; }
        .podium-step.silver .base { height: 150px; background-color: #ced4da; border-color: #adb5bd; }
        .podium-step.bronze .base { height: 100px; background-color: #e3b17b; border-color: #c68e56; }
        .podium-step.gold { order: 2; }
        .podium-step.silver { order: 1; }
        .podium-step.bronze { order: 3; }
        .podium-step .content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            width: 150%;
            white-space: normal;
            word-wrap: break-word;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .podium-step .medal-icon {
            animation: pulse 1.5s infinite ease-in-out;
        }
        .btn-remove-funcionario {
            padding: 0;
            margin-left: 5px;
            line-height: 1;
        }
        .progress-bar {
            transition: width 0.5s linear;
        }
        /* Novos estilos */
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 2px 5px;
        }
        .paused {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .paused-badge {
            background-color: #dc3545;
        }
        
        /* Novos estilos para dashboard */
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            background-color: white;
        }
        .dashboard-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.2rem;
        }
        .thermometer {
            width: 100%;
            height: 300px;
            position: relative;
            margin: 20px auto;
        }
        .thermometer-body {
            width: 30px;
            height: 200px;
            background: linear-gradient(to top, #f00, #ff0, #0f0);
            border-radius: 15px;
            border: 2px solid #333;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 50px;
        }
        .thermometer-bulb {
            width: 60px;
            height: 60px;
            background: #f00;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            border: 2px solid #333;
        }
        .thermometer-mercury {
            width: 26px;
            background: #333;
            border-radius: 10px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 60px;
            transition: height 0.5s ease;
        }
        .thermometer-labels {
            position: absolute;
            right: 10px;
            top: 0;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .thermometer-labels span {
            font-size: 12px;
        }
        .thermometer-title {
            text-align: center;
            font-weight: bold;
        }
        .thermometer-value {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
            position: absolute;
            align-items: center;
        }
        .meta-input {
            margin-top: 15px;
        }
        .meta-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .meta-input button {
            margin-top: 5px;
            width: 100%;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
        .docas-ordenadas {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .docas-ordenadas .doca-container {
            flex: 1 1 calc(33% - 15px);
            min-width: 250px;
        }
        .summary-card {
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  background: #f8f9fa;
}
.summary-card .card-body {
  padding: 1rem;
}
.thermometer-wrapper {
  position: relative;
  width: 100%;
  height: 280px;
  margin-top: 1rem;
}
.thermometer-title {
  position: absolute;
  top: 0; left: 50%;
  transform: translateX(-50%);
  font-weight: bold;
}
.thermometer-body {
  position: absolute;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px; height: 180px;
  background: #e9ecef;
  border-radius: 15px;
  overflow: hidden;
}
.thermometer-mercury {
  position: absolute;
  bottom: 0; left: 50%;
  transform: translateX(-50%);
  width: 26px; background: #007bff;
  border-radius: 10px;
  transition: height .5s ease;
  height: 0;
}
.thermometer-bulb {
  position: absolute;
  bottom: 0; left: 50%;
  transform: translateX(-50%);
  width: 50px; height: 50px;
  background: #007bff;
  border-radius: 50%;
}
.thermometer-labels {
  position: absolute;
  bottom: 50px; left: calc(50% + 20px);
  display: flex; flex-direction: column;
  justify-content: space-between; height: 180px;
}
.dashboard-card {
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border-radius: 8px;
  background: #fff;
}
    </style>
</head>
<body>
    <!-- Tela de Login/Seleção de Unidade -->
    <div id="loginContainer" class="container login-container">
        <div class="text-center mb-4">
            <h2>Sistema de Carregamento</h2>
            <p class="text-muted">Selecione sua unidade para continuar</p>
        </div>
        <div class="mb-3">
            <label for="unidade" class="form-label">Unidade</label>
            <select class="form-select" id="unidade">
                <option value="">Selecione a unidade</option>
                <option value="cd_cariacica">CD Cariacica</option>
                <option value="fabrica_belem">Fábrica Belém</option>
                <!-- Outras unidades podem ser adicionadas aqui -->
            </select>
        </div>
        <div class="mb-3">
            <label for="senha" class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" placeholder="Digite sua senha">
        </div>
        <button id="btnLogin" class="btn btn-primary w-100">Entrar</button>
        <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <!-- Sistema Principal (oculto inicialmente) -->
    <div id="mainContainer" class="container" style="display: none;">
        <h1 class="text-center mb-4">Sistema de Carregamento de Caminhões</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Operação</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab" aria-controls="cadastro" aria-selected="false">Cadastrar Funcionário</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="busca-tab" data-bs-toggle="tab" data-bs-target="#busca" type="button" role="tab" aria-controls="busca" aria-selected="false">Buscar Funcionário</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard2-tab" data-bs-toggle="tab" data-bs-target="#dashboard2" type="button" role="tab" aria-controls="dashboard2" aria-selected="false">Dashboard Completo</button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#ranking" type="button" role="tab" aria-controls="ranking" aria-selected="false">Ranking</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="docas-tab" data-bs-toggle="tab" data-bs-target="#docas" type="button" role="tab" aria-controls="docas" aria-selected="false">Docas</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">Histórico</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- ABA PRINCIPAL (OPERAÇÃO) -->
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Operações de Carregamento</h5>
                                <button id="btnIniciarCarregamento" class="btn btn-primary btn-lg w-100 mb-3">Iniciar Carregamento</button>
                                <button id="btnFinalizarCarregamento" class="btn btn-success btn-lg w-100">Finalizar Carregamento</button>
                                <button id="btnPausarCarregamento" class="btn btn-warning btn-lg w-100 mt-3">Pausar/Retomar Carregamento</button>
                                <button id="btnAddFuncionarioCarregamento" class="btn btn-secondary btn-lg w-100 mt-3">Adicionar Funcionário a Carregamento Existente</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Informações</h5>
                                <p>Use a câmera para ler o QR code do funcionário ou digite manualmente o código.</p>
                                <p>Os códigos começam com <strong>GZL-EO</strong> seguido de identificação única.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3" id="formContainer" style="display: none;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title" id="formTitle">Informações do Carregamento</h5>
                                <div id="carregadoresContainer">
                                    <div class="mb-3">
                                        <label for="funcionarioId" class="form-label">Código do Funcionário Principal</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control funcionario-input" placeholder="Ex: GZL-EO-1234">
                                            <button class="btn btn-outline-secondary btn-scan" type="button">
                                                <i class="bi bi-camera"></i> Ler QR Code
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button id="btnAddCarregador" class="btn btn-outline-primary btn-sm add-carregador-btn">
                                    <i class="bi bi-plus"></i> Adicionar outro carregador
                                </button>
                                <div class="mb-3">
                                    <label for="placaCaminhao" class="form-label">DT</label>
                                    <input type="text" class="form-control" id="placaCaminhao" placeholder="Ex: 1234">
                                </div>
                                <div class="mb-3">
                                    <label for="docaNumero" class="form-label">Doca</label>
                                    <select class="form-select" id="docaNumero">
                                        <option value="">Selecione a Doca</option>
                                        <option value="1">Doca 1</option>
                                        <option value="2">Doca 2</option>
                                        <option value="3">Doca 3</option>
                                        <option value="4">Doca 4</option>
                                        <option value="5">Doca 5</option>
                                        <option value="6">Doca 6</option>
                                        <option value="7">Doca 7</option>
                                        <option value="8">Doca 8</option>
                                        <option value="9">Doca 9</option>
                                        <option value="10">Doca 10</option>
                                        <option value="11">Doca 11</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="armagensContainer" style="display: none;">
                                    <label for="armagens" class="form-label">Armagens (onde foi buscar material)</label>
                                    <select class="form-select" id="armagens" multiple="multiple">
                                        <option value="Armazém 1">Armazém 1</option>
                                        <option value="Armazém 2">Armazém 2</option>
                                        <option value="Armazém 3">Armazém 3</option>
                                        <option value="Armazém 4">Armazém 4</option>
                                        <option value="Armazém 5">Armazém 5</option>
                                        <option value="Armazém 6">Armazém 6</option>
                                        <option value="Armazém 7">Armazém 7</option>
                                        <option value="Armazém 8">Armazém 8</option>
                                        <option value="Armazém Externo 1">Armazém Externo 1</option>
                                        <option value="Armazém Externo 2">Armazém Externo 2</option>
                                        <option value="Armazém Externo 3">Armazém Externo 3</option>
                                        <option value="Armazém Externo 4">Armazém Externo 4</option>
                                        <option value="Armazém Externo 5">Armazém Externo 5</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="mixContainer" style="display: none;">
                                    <label for="mixMaterial" class="form-label">Quantidade de Mix de Material</label>
                                    <input type="number" class="form-control" id="mixMaterial" placeholder="Ex: 5" min="1">
                                    <label for="toneladas" class="form-label mt-2">Toneladas Carregadas</label>
                                    <input type="number" class="form-control" id="toneladas" placeholder="Ex: 10.5" step="0.1" min="0">
                                </div>
                                <button id="btnConfirmar" class="btn btn-primary">Confirmar</button>
                                <button id="btnCancelar" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Formulário para Adicionar Funcionário a Carregamento Existente -->
                 <div class="row mt-3" id="formAddFuncionarioContainer" style="display: none;">
                     <div class="col-md-6">
                         <div class="card">
                             <div class="card-body">
                                 <h5 class="card-title">Adicionar Funcionário a Carregamento Existente</h5>
                                 <div class="mb-3">
                                     <label for="addFuncionarioId" class="form-label">Código do Funcionário a Adicionar</label>
                                     <div class="input-group">
                                         <input type="text" class="form-control" id="addFuncionarioId" placeholder="Ex: GZL-EO-1234">
                                          <button class="btn btn-outline-secondary btn-scan" type="button" data-target-input="#addFuncionarioId">
                                             <i class="bi bi-camera"></i> Ler QR Code
                                         </button>
                                     </div>
                                 </div>
                                 <div class="mb-3">
                                     <label for="carregamentoDestino" class="form-label">Selecionar Carregamento (Doca - DT)</label>
                                     <select class="form-select" id="carregamentoDestino">
                                         <option value="">Selecione um carregamento em andamento</option>
                                         <!-- Opções serão preenchidas via JS -->
                                     </select>
                                 </div>
                                 <button id="btnConfirmarAddFuncionario" class="btn btn-primary">Adicionar Funcionário</button>
                                 <button id="btnCancelarAddFuncionario" class="btn btn-secondary">Cancelar</button>
                             </div>
                         </div>
                     </div>
                 </div>

                <!-- Formulário para Pausar/Retomar Carregamento -->
                <div class="row mt-3" id="formPausarContainer" style="display: none;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Pausar/Retomar Carregamento</h5>
                                <div class="mb-3">
                                    <label for="pausarFuncionarioId" class="form-label">Código do Funcionário</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pausarFuncionarioId" placeholder="Ex: GZL-EO-1234">
                                        <button class="btn btn-outline-secondary btn-scan" type="button" data-target-input="#pausarFuncionarioId">
                                            <i class="bi bi-camera"></i> Ler QR Code
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="carregamentoPausar" class="form-label">Selecionar Carregamento (Doca - DT)</label>
                                    <select class="form-select" id="carregamentoPausar">
                                        <option value="">Selecione um carregamento em andamento</option>
                                        <!-- Opções serão preenchidas via JS -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="acaoPausar" class="form-label">Ação</label>
                                    <select class="form-select" id="acaoPausar">
                                        <option value="pausar">Pausar (horário de almoço)</option>
                                        <option value="retomar">Retomar (após almoço)</option>
                                        <option value="pausar_chuva">Pausar (chuva)</option>
                                        <option value="retomar_chuva">Retomar (após chuva)</option>
                                    </select>
                                </div>
                                <button id="btnConfirmarPausar" class="btn btn-primary">Confirmar</button>
                                <button id="btnCancelarPausar" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scanner de QR Code -->
                <div class="row mt-3" id="scannerContainer" style="display: none;">
                    <div class="col-md-6 offset-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Scanner de QR Code</h5>
                                <div id="videoContainer">
                                    <video id="video" playsinline></video>
                                    <div id="scanOverlay">
                                        <div id="scanBox"></div>
                                    </div>
                                    <button id="btnCloseScanner" class="btn btn-danger btn-sm">X Fechar</button>
                                </div>
                                <div id="scanResult" class="mt-3 alert alert-info" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Carregamentos em Andamento</h5>
                                <div id="carregamentosAndamento"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA DE CADASTRO -->
            <div class="tab-pane fade" id="cadastro" role="tabpanel" aria-labelledby="cadastro-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="novoNome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="novoNome" placeholder="Ex: João da Silva">
                        </div>
                        <div class="mb-3">
                            <label for="novoCargo" class="form-label">Cargo</label>
                            <input type="text" class="form-control" id="novoCargo" placeholder="Ex: Carregador">
                        </div>
                        <button id="btnCadastrar" class="btn btn-primary">Cadastrar Funcionário</button>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Código do Funcionário</h5>
                                <div id="codigoGerado" class="codigo-funcionario mb-3" style="display: none;"></div>
                                <div id="qrCodeContainer" style="display: none;">
                                    <canvas id="qrCodeCanvas"></canvas>
                                </div>
                                <div id="infoCadastro"></div>
                                <button id="btnDownloadPDF" class="btn btn-success mt-2" style="display: none;">Download PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA DE BUSCA -->
            <div class="tab-pane fade" id="busca" role="tabpanel" aria-labelledby="busca-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="buscarFuncionario" class="form-label">Código ou Nome do Funcionário</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="buscarFuncionario" placeholder="Ex: GZL-EO-1234 ou João Silva">
                                <button class="btn btn-outline-secondary btn-scan" type="button" data-target-input="#buscarFuncionario">
                                    <i class="bi bi-camera"></i> Ler QR Code
                                </button>
                            </div>
                        </div>
                        <button id="btnBuscar" class="btn btn-info">Buscar</button>
                        <div id="infoFuncionario" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ABA DASHBOARD -->
            <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="row">
                    <div class="col-12">
                        <h3>Dashboard em Tempo Real</h3>
                        <div class="alert alert-info">
                            <strong>Total de Carregamentos em Andamento:</strong> <span id="totalCarregamentosHoje">0</span>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">Carregamentos em Andamento</h5>
                                <div id="dashboardCarregamentos"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">Funcionários em Ação</h5>
                                <div id="dashboardFuncionarios"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NOVA ABA DASHBOARD COMPLETO -->
            <div class="tab-pane fade" id="dashboard2" role="tabpanel" aria-labelledby="dashboard2-tab">
                <!-- Título e Unidade -->
                <div class="row mb-4">
                    <div class="col">
                    <h3>Dashboard Completo</h3>
                    <div class="alert alert-info py-2">
                        <i class="bi bi-building"></i>
                        <strong>Unidade:</strong>
                        <span id="dashboardUnidade">—</span>
                    </div>
                    </div>
                </div>

                <!-- 1) Summary Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                    <div class="card text-center summary-card">
                        <div class="card-body">
                        <h6 class="card-title">Caminhões</h6>
                        <p class="display-5" id="sumCaminhoes">0</p>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-2">
                    <div class="card text-center summary-card">
                        <div class="card-body">
                        <h6 class="card-title">Toneladas</h6>
                        <p class="display-5" id="sumToneladas">0</p>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-2">
                    <div class="card text-center summary-card">
                        <div class="card-body">
                        <h6 class="card-title">Média Tempo</h6>
                        <p class="display-5" id="sumMediaTempo">0 min</p>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-2">
                    <div class="card text-center summary-card">
                        <div class="card-body">
                        <h6 class="card-title">Docas Ocupadas</h6>
                        <p class="display-5" id="sumDocasOcupadas">0</p>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-4">
                    <div class="card text-center summary-card">
                        <div class="card-body">
                        <h6 class="card-title">Meta Toneladas</h6>
                        <p class="display-5" id="metaToneladas">0</p>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- 2) Termômetros lado a lado -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Toneladas Hoje</h5>
                        <div class="thermometer-wrapper">
                        <div class="thermometer-title">Real: <span id="toneladasValue">0</span> ton</div>
                        <div class="thermometer-body">
                            <div id="toneladasMercury" class="thermometer-mercury"></div>
                        </div>
                        <div class="thermometer-bulb"></div>
                        <div class="thermometer-labels">
                            <span>100%</span><span>75%</span><span>50%</span><span>25%</span><span>0%</span>
                        </div>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Caminhões Hoje</h5>
                        <div class="thermometer-wrapper">
                        <div class="thermometer-title">Real: <span id="caminhoesValue">0</span></div>
                        <div class="thermometer-body">
                            <div id="caminhoesMercury" class="thermometer-mercury"></div>
                        </div>
                        <div class="thermometer-bulb"></div>
                        <div class="thermometer-labels">
                            <span>100%</span><span>75%</span><span>50%</span><span>25%</span><span>0%</span>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- 3) Gráficos -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Produtividade por Hora</h5>
                        <canvas id="produtividadeChart"></canvas>
                    </div>
                    </div>
                    <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Top 5 Carregadores</h5>
                        <canvas id="topCarregadoresChart"></canvas>
                    </div>
                    </div>
                </div>

                <!-- 4) Status das Docas -->
                <div class="row g-3">
                    <div class="col-12">
                    <div class="dashboard-card">
                        <h5>Status das Docas</h5>
                        <div class="row" id="docasStatusResumo">
                        <!-- será preenchido via JS -->
                        </div>
                    </div>
                    </div>
                </div>
                </div>

             <!-- ABA RANKING -->
             <div class="tab-pane fade" id="ranking" role="tabpanel" aria-labelledby="ranking-tab">
                 <div class="row mt-3">
                     <div class="col-12 text-center">
                         <h2>Ranking Mensal de Carregamentos</h2>
                         <p class="text-muted">Os funcionários com mais carregamentos finalizados no mês.</p>
                     </div>
                 </div>
                 <div class="row mt-4">
                     <div class="col-12">
                         <div class="card dashboard-card">
                             <div class="card-body">
                                 <h5 id="card-title-text-centerrr" class="card-title text-center">Pódio</h5>
                                 <div id="podiumContainer" class="podium-container">
                                     <!-- Pódio será preenchido via JS -->
                                 </div>
                                  <p class="text-center mt-4" id="rankingMesAno"></p>
                                  <div id="rankingLoading" class="text-center" style="display: none;">
                                      <div class="spinner-border text-primary" role="status">
                                          <span class="visually-hidden">Carregando...</span>
                                      </div>
                                  </div>
                                 <div id="rankingEmpty" class="alert alert-info text-center mt-3" style="display: none;">
                                     Sem dados suficientes para o ranking deste mês.
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>

            <!-- ABA DOCAS -->
            <div class="tab-pane fade" id="docas" role="tabpanel" aria-labelledby="docas-tab">
                <div class="row">
                    <div class="col-12">
                        <h3>Status das Docas</h3>
                        <p class="text-muted">Monitoramento em tempo real das docas de carregamento</p>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Resumo de Hoje</h5>
                            <p><strong>Toneladas Carregadas:</strong>
                            <span id="resumoToneladas">0</span>
                            </p>
                            <p><strong>Caminhões Carregados:</strong>
                            <span id="resumoCaminhoes">0</span>
                            </p>
                        </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3" id="docasContainer">
                    <!-- As docas serão preenchidas via JavaScript -->
                </div>
            </div>

            <!-- ABA HISTÓRICO -->
            <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
                <!-- Conteúdo do histórico (inicialmente oculto) -->
                <div id="historicoContent">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="filtroMes" class="form-label">Mês</label>
                                <select class="form-select" id="filtroMes">
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Março</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="filtroAno" class="form-label">Ano</label>
                                <select class="form-select" id="filtroAno">
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="filtroFuncionario" class="form-label">Funcionário (opcional)</label>
                                <input type="text" class="form-control" id="filtroFuncionario" placeholder="Código do Funcionário">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <button id="btnFiltrar" class="btn btn-primary">Filtrar</button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Estatísticas Gerais (Mês/Filtro)</h5>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Total de Caminhões</h6>
                                                    <p class="display-4 text-center" id="totalCaminhoes">0</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Média de Tempo</h6>
                                                    <p class="display-4 text-center" id="mediaTempo">0 min</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Valor Total Estimado</h6>
                                                    <p class="display-4 text-center" id="valorTotal">R$ 0,00</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Ranking Completo (Mês/Filtro)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Posição</th>
                                                    <th>Funcionário</th>
                                                    <th>Carregamentos</th>
                                                    <th>Tempo Médio</th>
                                                    <th>Valor Ganho Estimado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topFuncionariosHistorico">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Histórico Completo (Mês/Filtro)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Data</th>
                                                    <th>DT</th>
                                                    <th>Funcionário Principal</th>
                                                    <th>Início</th>
                                                    <th>Fim</th>
                                                    <th>Tempo</th>
                                                    <th>Doca</th>
                                                    <th>Armagens</th>
                                                    <th>Mix</th>
                                                    <th>Toneladas</th>
                                                    <th>Pausas</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabelaHistorico">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Mensagem de acesso restrito -->
                <div id="historicoRestrito" class="alert alert-warning mt-3 text-center">
                    Acesso ao histórico restrito. Por favor, autentique-se para visualizar.
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes do funcionário -->
    <div class="modal fade" id="modalFuncionario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFuncionarioTitle">Detalhes do Funcionário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalFuncionarioBody">
                    <!-- Conteúdo será preenchido via JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de senha para histórico -->
    <div class="modal fade" id="modalSenhaHistorico" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Acesso ao Histórico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inputSenhaHistorico" class="form-label">Digite a senha de acesso:</label>
                        <input type="password" class="form-control" id="inputSenhaHistorico" placeholder="Digite a senha">
                    </div>
                    <div id="senhaIncorreta" class="alert alert-danger d-none">Senha incorreta!</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnAcessarHistorico">Acessar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="text-end fixed-bottom mb-3 me-3">
        <button id="btnLogout" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i> Sair
        </button>
    </div>

    <!-- Inclui as bibliotecas necessárias -->
    <script src="../js/key.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // Inicializa o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBAH_sO68BD_vt9J40Hf8rdgLTNQEuEEBc",
            authDomain: "produtividade-bc.firebaseapp.com",
            projectId: "produtividade-bc",
            storageBucket: "produtividade-bc.appspot.com",
            messagingSenderId: "665932698083",
            appId: "1:665932698083:web:1c807c6b1571e3024bd0d6",
            measurementId: "G-608P3H613B"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Referências do banco de dados
        const funcionariosRef = database.ref('funcionarios');
        const carregamentosRef = database.ref('carregamentos');
        const docasRef = database.ref('docas');
        const unidadesRef = database.ref('unidades');
        const metasRef = database.ref('metas');

        // Variáveis globais
        let operacaoAtual = null; // 'iniciar', 'finalizar', 'addFuncionario', 'pausar'
        let carregamentosEmAndamento = {};
        let intervalos = {};
        let scannerActive = false;
        let stream = null;
        let currentScannerInput = null;
        let historicoAutenticado = false;
        let unidadeAtual = null; // Armazena a unidade selecionada
        let metaToneladas = 0;
        let metaCaminhoes = 0;
        let toneladasHoje = 0;
        let caminhoesHoje = 0;
        let produtividadeChart = null;
        let topCarregadoresChart = null;

        // Valor base por colaborador por carregamento COMPLETO
        const VALOR_POR_COLABORADOR_POR_CARREGAMENTO = 2.50;
        const TEMPO_LIMITE_MINUTOS = 140; // 2 horas e 20 minutos

        // Inicializa o Select2 para o campo de armagens
        $(document).ready(function() {
            $('#armagens').select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecione as armagens',
                closeOnSelect: false,
                width: '100%'
            });
        });

        // Função principal de inicialização após autenticação
        function inicializarSistema() {
            // Oculta o conteúdo do histórico inicialmente e mostra a mensagem de restrição
            document.getElementById('historicoContent').style.display = 'none';
            document.getElementById('historicoRestrito').style.display = 'block';

            // Atualiza o nome da unidade no dashboard
            document.getElementById('dashboardUnidade').textContent = unidadeAtual === 'cd_cariacica' ? 'CD Cariacica' : 'Fábrica Belém';

            // Carrega as metas do dia
            carregarMetasDoDia();
            
            atualizarTemposContinuamente();
            atualizarDashboard();
            atualizarRankingDashboard();
            atualizarDashboardCompleto();

            // Configura o filtro do histórico para o mês/ano atual
            const hoje = new Date();
            const mesAtual = (hoje.getMonth() + 1).toString().padStart(2, '0');
            const anoAtual = hoje.getFullYear().toString();

            document.getElementById('filtroMes').value = mesAtual;
            document.getElementById('filtroAno').value = anoAtual;

            // Event Listeners
            document.getElementById('btnIniciarCarregamento').addEventListener('click', function() {
                operacaoAtual = 'iniciar';
                hideAllForms();
                document.getElementById('formContainer').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Iniciar Carregamento';
                document.getElementById('btnConfirmar').textContent = 'Iniciar';
                document.getElementById('placaCaminhao').closest('.mb-3').style.display = 'block';
                document.getElementById('docaNumero').closest('.mb-3').style.display = 'block';
                document.getElementById('armagensContainer').style.display = 'block';
                document.getElementById('mixContainer').style.display = 'none';
                document.getElementById('btnAddCarregador').style.display = 'block';
                
                // Limpa os inputs
                document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                $('#armagens').val(null).trigger('change');
                
                // Remove carregadores adicionais, exceto o primeiro
                const carregadoresContainer = document.getElementById('carregadoresContainer');
                while (carregadoresContainer.children.length > 1) {
                    carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                }
            });

            document.getElementById('btnFinalizarCarregamento').addEventListener('click', function() {
                operacaoAtual = 'finalizar';
                hideAllForms();
                document.getElementById('formContainer').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Finalizar Carregamento';
                document.getElementById('btnConfirmar').textContent = 'Finalizar';
                document.getElementById('placaCaminhao').closest('.mb-3').style.display = 'none';
                document.getElementById('docaNumero').closest('.mb-3').style.display = 'none';
                document.getElementById('armagensContainer').style.display = 'none';
                document.getElementById('mixContainer').style.display = 'block';
                document.getElementById('btnAddCarregador').style.display = 'none';
                
                // Limpa os inputs
                document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                document.getElementById('mixMaterial').value = '';
                document.getElementById('toneladas').value = '';
                
                // Remove carregadores adicionais, exceto o primeiro
                const carregadoresContainer = document.getElementById('carregadoresContainer');
                while (carregadoresContainer.children.length > 1) {
                    carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                }
            });

            document.getElementById('btnPausarCarregamento').addEventListener('click', function() {
                operacaoAtual = 'pausar';
                hideAllForms();
                document.getElementById('formPausarContainer').style.display = 'block';
                preencherSelectCarregamentosPausar();
            });

            document.getElementById('btnAddFuncionarioCarregamento').addEventListener('click', function() {
                operacaoAtual = 'addFuncionario';
                hideAllForms();
                document.getElementById('formAddFuncionarioContainer').style.display = 'block';
                document.getElementById('addFuncionarioId').value = '';
                preencherSelectCarregamentos();
            });

            document.getElementById('btnConfirmar').addEventListener('click', function() {
                if (operacaoAtual === 'iniciar') {
                    iniciarCarregamento();
                } else if (operacaoAtual === 'finalizar') {
                    finalizarCarregamento();
                }
            });

            document.getElementById('btnCancelar').addEventListener('click', function() {
                hideAllForms();
                document.getElementById('placaCaminhao').closest('.mb-3').style.display = 'block';
                document.getElementById('docaNumero').closest('.mb-3').style.display = 'block';
                document.getElementById('btnAddCarregador').style.display = 'block';
                document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                const carregadoresContainer = document.getElementById('carregadoresContainer');
                while (carregadoresContainer.children.length > 1) {
                    carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                }
            });

            document.getElementById('btnCancelarAddFuncionario').addEventListener('click', function() {
                hideAllForms();
            });

            document.getElementById('btnCancelarPausar').addEventListener('click', function() {
                hideAllForms();
            });

            document.getElementById('btnConfirmarPausar').addEventListener('click', pausarRetomarCarregamento);

            document.getElementById('btnConfirmarAddFuncionario').addEventListener('click', addFuncionarioToCarregamento);

            document.getElementById('btnAddCarregador').addEventListener('click', function() {
                const container = document.getElementById('carregadoresContainer');
                const newInput = document.createElement('div');
                newInput.className = 'mb-3';
                newInput.innerHTML = `
                    <label class="form-label">Código do Carregador Adicional</label>
                    <div class="input-group">
                        <input type="text" class="form-control funcionario-input" placeholder="Ex: GZL-EO-1234">
                        <button class="btn btn-outline-secondary btn-scan" type="button">
                            <i class="bi bi-camera"></i> Ler QR Code
                        </button>
                    </div>
                `;
                container.appendChild(newInput);

                newInput.querySelector('.btn-scan').addEventListener('click', function() {
                    iniciarScanner(newInput.querySelector('.funcionario-input'));
                });
            });

            document.querySelectorAll('.btn-scan').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetInputSelector = this.getAttribute('data-target-input');
                    const input = targetInputSelector ? document.querySelector(targetInputSelector) : this.closest('.input-group').querySelector('.funcionario-input');
                    if (input) {
                        iniciarScanner(input);
                    } else {
                        console.error("Input target não encontrado para o scanner.");
                    }
                });
            });

            document.getElementById('btnCloseScanner').addEventListener('click', pararScanner);

            // Cadastro de funcionário
            document.getElementById('btnCadastrar').addEventListener('click', function() {
                const nome = document.getElementById('novoNome').value.trim();
                const cargo = document.getElementById('novoCargo').value.trim();

                if (!nome || !cargo) {
                    alert('Preencha todos os campos!');
                    return;
                }

                const codigo = gerarCodigoFuncionario();
                document.getElementById('codigoGerado').textContent = codigo;
                document.getElementById('codigoGerado').style.display = 'block';

                gerarQRCode(codigo);
                document.getElementById('qrCodeContainer').style.display = 'block';

                document.getElementById('infoCadastro').innerHTML = `
                    <div class="alert alert-success mt-3">
                        <strong>Funcionário cadastrado com sucesso!</strong><br>
                        Nome: ${nome}<br>
                        Cargo: ${cargo}
                    </div>
                `;

                document.getElementById('btnDownloadPDF').style.display = 'block';

                funcionariosRef.child(codigo).set({
                    nome,
                    cargo,
                    dataCadastro: new Date().getTime(),
                    unidade: unidadeAtual // Adiciona a unidade ao cadastrar funcionário
                });
            });

            // Download PDF
            document.getElementById('btnDownloadPDF').addEventListener('click', function() {
                const codigo = document.getElementById('codigoGerado').textContent;
                const nome = document.getElementById('novoNome').value.trim();
                const cargo = document.getElementById('novoCargo').value.trim();
                gerarPDFCodigo(codigo, nome, cargo);
            });

            // Buscar funcionário
            document.getElementById('btnBuscar').addEventListener('click', function() {
                const termoBusca = document.getElementById('buscarFuncionario').value.trim();
                if (!termoBusca) {
                    alert('Informe o código ou nome do funcionário!');
                    return;
                }

                if (termoBusca.startsWith('GZL-EO')) {
                    buscarFuncionario(termoBusca, true);
                } else {
                    funcionariosRef.orderByChild('nome').once('value', (snapshot) => {
                        const funcionarios = snapshot.val() || {};
                        const resultados = Object.entries(funcionarios)
                            .filter(([id, func]) =>
                                func.nome && func.nome.toLowerCase().includes(termoBusca.toLowerCase())
                            )
                            .map(([id, func]) => ({ id, ...func }));

                        if (resultados.length === 0) {
                            alert('Nenhum funcionário encontrado com esse nome!');
                        } else if (resultados.length === 1) {
                            buscarFuncionario(resultados[0].id, true);
                        } else {
                            let html = '<div class="list-group mb-3">';
                            resultados.forEach(func => {
                                html += `
                                    <a href="#" class="list-group-item list-group-item-action"
                                    onclick="buscarFuncionario('${func.id}', true); return false;">
                                        ${func.nome} <small class="text-muted">${func.id}</small>
                                    </a>
                                `;
                            });
                            html += '</div>';
                            document.getElementById('infoFuncionario').innerHTML = html;
                        }
                    });
                }
            });

            // Acesso ao histórico
            document.getElementById('historico-tab').addEventListener('click', function(e) {
                if (!historicoAutenticado) {
                    e.preventDefault();
                    document.getElementById('inputSenhaHistorico').value = '';
                    document.getElementById('senhaIncorreta').classList.add('d-none');
                    const modal = new bootstrap.Modal(document.getElementById('modalSenhaHistorico'));
                    modal.show();
                } else {
                    const hoje = new Date();
                    atualizarHistorico(hoje.getMonth() + 1, hoje.getFullYear());
                }
            });

            document.getElementById('btnAcessarHistorico').addEventListener('click', verificarSenhaHistorico);

            document.getElementById('inputSenhaHistorico').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarSenhaHistorico();
                }
            });

            document.getElementById('btnFiltrar').addEventListener('click', function() {
                if (historicoAutenticado) {
                    const mes = parseInt(document.getElementById('filtroMes').value);
                    const ano = parseInt(document.getElementById('filtroAno').value);
                    const funcionarioId = document.getElementById('filtroFuncionario').value.trim() || null;
                    carregamentosRef.off('value', null, null);
                    atualizarHistorico(mes, ano, funcionarioId);
                }
            });

            document.getElementById('ranking-tab').addEventListener('click', function() {
                atualizarRankingDashboard();
            });

            // Event listeners para o dashboard completo
            document.getElementById('btnSalvarMetaToneladas').addEventListener('click', salvarMetaToneladas);
            document.getElementById('btnSalvarMetaCaminhoes').addEventListener('click', salvarMetaCaminhoes);
            document.getElementById('dashboard2-tab').addEventListener('click', atualizarDashboardCompleto);
        }

        // Função para carregar as metas do dia
        function carregarMetasDoDia() {
            const hoje = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
            
            metasRef.child(unidadeAtual).child(hoje).once('value', (snapshot) => {
                const metas = snapshot.val() || {};
                
                if (metas.toneladas) {
                    metaToneladas = metas.toneladas;
                    document.getElementById('metaToneladas').textContent = metaToneladas;
                    document.getElementById('inputMetaToneladas').value = metaToneladas;
                }
                
                if (metas.caminhoes) {
                    metaCaminhoes = metas.caminhoes;
                    document.getElementById('metaCaminhoes').textContent = metaCaminhoes;
                    document.getElementById('inputMetaCaminhoes').value = metaCaminhoes;
                }
                
                atualizarTermometros();
            });
        }

        // Função para salvar a meta de toneladas
        function salvarMetaToneladas() {
            const valor = parseInt(document.getElementById('inputMetaToneladas').value);
            if (isNaN(valor)) {
                alert('Digite um valor válido para a meta de toneladas!');
                return;
            }
            
            const hoje = new Date().toISOString().split('T')[0];
            metasRef.child(unidadeAtual).child(hoje).update({
                toneladas: valor
            }).then(() => {
                metaToneladas = valor;
                document.getElementById('metaToneladas').textContent = valor;
                atualizarTermometros();
                alert('Meta de toneladas salva com sucesso!');
            }).catch(error => {
                console.error('Erro ao salvar meta de toneladas:', error);
                alert('Erro ao salvar meta de toneladas.');
            });
        }

        // Função para salvar a meta de caminhões
        function salvarMetaCaminhoes() {
            const valor = parseInt(document.getElementById('inputMetaCaminhoes').value);
            if (isNaN(valor)) {
                alert('Digite um valor válido para a meta de caminhões!');
                return;
            }
            
            const hoje = new Date().toISOString().split('T')[0];
            metasRef.child(unidadeAtual).child(hoje).update({
                caminhoes: valor
            }).then(() => {
                metaCaminhoes = valor;
                document.getElementById('metaCaminhoes').textContent = valor;
                atualizarTermometros();
                alert('Meta de caminhões salva com sucesso!');
            }).catch(error => {
                console.error('Erro ao salvar meta de caminhões:', error);
                alert('Erro ao salvar meta de caminhões.');
            });
        }

        // Função para atualizar os termômetros
        function atualizarTermometros() {
            // Atualiza o termômetro de toneladas
            const porcentagemToneladas = metaToneladas > 0 ? Math.min(100, (toneladasHoje / metaToneladas) * 100) : 0;
            const mercuryToneladas = document.getElementById('toneladasMercury');
            mercuryToneladas.style.height = `${porcentagemToneladas}%`;
            mercuryToneladas.style.backgroundColor = porcentagemToneladas >= 100 ? '#4CAF50' : 
                                                     porcentagemToneladas >= 75 ? '#8BC34A' : 
                                                     porcentagemToneladas >= 50 ? '#FFEB3B' : 
                                                     porcentagemToneladas >= 25 ? '#FF9800' : '#F44336';
            document.getElementById('toneladasValue').textContent = `${toneladasHoje} ton`;
            
            // Atualiza o termômetro de caminhões
            const porcentagemCaminhoes = metaCaminhoes > 0 ? Math.min(100, (caminhoesHoje / metaCaminhoes) * 100) : 0;
            const mercuryCaminhoes = document.getElementById('caminhoesMercury');
            mercuryCaminhoes.style.height = `${porcentagemCaminhoes}%`;
            mercuryCaminhoes.style.backgroundColor = porcentagemCaminhoes >= 100 ? '#4CAF50' : 
                                                     porcentagemCaminhoes >= 75 ? '#8BC34A' : 
                                                     porcentagemCaminhoes >= 50 ? '#FFEB3B' : 
                                                     porcentagemCaminhoes >= 25 ? '#FF9800' : '#F44336';
            document.getElementById('caminhoesValue').textContent = `${caminhoesHoje} caminhões`;
        }

        // Função para atualizar o dashboard completo
        function atualizarDashboardCompleto() {
  const hoje = new Date();
  const startOfDay = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()).getTime();
  const endOfDay   = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(),23,59,59).getTime();

  carregamentosRef
    .orderByChild('fim')
    .startAt(startOfDay)
    .endAt(endOfDay)
    .once('value', snap => {
      const dados = snap.val() || {};
      let totalTon = 0, totalCam = 0, somaTempo = 0, countCar = 0;
      let ocupadas = 0;

      Object.values(dados).forEach(c => {
        if (c.unidade === unidadeAtual && c.finalizado) {
          totalCam++;
          totalTon += parseFloat(c.toneladas || 0);
          somaTempo += (c.fim - c.inicio) / 60000;  // minutos
        }
      });

      // conta docas ocupadas
      docasRef.once('value', ds => {
        Object.values(ds.val()||{}).forEach(d => {
          if (d.ocupada) ocupadas++;
        });
        document.getElementById('sumDocasOcupadas').textContent = ocupadas;
      });

      // preenche summary
      document.getElementById('sumCaminhoes').textContent     = totalCam;
      document.getElementById('sumToneladas').textContent    = totalTon.toFixed(1);
      const medTempo = totalCam ? (somaTempo/totalCam).toFixed(0)+' min' : '0 min';
      document.getElementById('sumMediaTempo').textContent   = medTempo;
      document.getElementById('metaToneladas').textContent   = metaToneladas;

      // termômetros
      const pctTon  = metaToneladas ? Math.min(100, totalTon/metaToneladas*100) : 0;
      const pctCam  = metaCaminhoes ? Math.min(100, totalCam/metaCaminhoes*100) : 0;
      document.getElementById('toneladasMercury').style.height  = pctTon+'%';
      document.getElementById('caminhoesMercury').style.height  = pctCam+'%';
      document.getElementById('toneladasValue').textContent     = `${totalTon.toFixed(1)} ton`;
      document.getElementById('caminhoesValue').textContent     = totalCam;

      // gráficos
      atualizarGraficoProdutividade(dados);
      atualizarGraficoTopCarregadores(dados);

      // status das docas em grid
      const statusDiv = document.getElementById('docasStatusResumo');
      statusDiv.innerHTML = '';
      docasRef.once('value', snapD => {
        const ds = snapD.val()||{};
        for (let i=1; i<=11; i++) {
          const d = ds[i]||{ocupada:false};
          statusDiv.innerHTML += `
            <div class="col-sm-3 col-md-2 mb-2">
              <div class="card text-center p-2 ${d.ocupada?'bg-danger text-white':'bg-success text-white'}">
                Doca ${i}<br>
                ${d.ocupada?'Ocupada':'Livre'}
              </div>
            </div>`;
        }
      });
    });
}

// chamar ao abrir a aba
document.getElementById('dashboard2-tab')
  .addEventListener('shown.bs.tab', () => {
    document.getElementById('dashboardUnidade').textContent =
      unidadeAtual==='cd_cariacica'?'CD Cariacica':'Fábrica Belém';
    atualizarDashboardCompleto();
  });

        // Função para atualizar o gráfico de produtividade por hora
        function atualizarGraficoProdutividade(carregamentos) {
            const horas = Array.from({length: 24}, (_, i) => i);
            const dadosPorHora = Array(24).fill(0);
            
            Object.values(carregamentos).forEach(c => {
                if (c.finalizado && c.unidade === unidadeAtual && c.fim) {
                    const hora = new Date(c.fim).getHours();
                    if (hora >= 0 && hora < 24) {
                        dadosPorHora[hora]++;
                    }
                }
            });
            
            const ctx = document.getElementById('produtividadeChart').getContext('2d');
            
            if (produtividadeChart) {
                produtividadeChart.destroy();
            }
            
            produtividadeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: horas.map(h => `${h}h`),
                    datasets: [{
                        label: 'Caminhões Carregados por Hora',
                        data: dadosPorHora,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora do Dia'
                            }
                        }
                    }
                }
            });
        }

        // Função para atualizar o gráfico de top carregadores
        function atualizarGraficoTopCarregadores(carregamentos) {
            const funcionariosStats = {};
            
            Object.values(carregamentos).forEach(c => {
                if (c.finalizado && c.unidade === unidadeAtual && c.participantes) {
                    Object.entries(c.participantes).forEach(([id, p]) => {
                        if (!funcionariosStats[id]) {
                            funcionariosStats[id] = {
                                count: 0,
                                nome: p.nome || id
                            };
                        }
                        funcionariosStats[id].count++;
                    });
                }
            });
            
            const topCarregadores = Object.entries(funcionariosStats)
                .map(([id, stats]) => ({ id, nome: stats.nome, count: stats.count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            const ctx = document.getElementById('topCarregadoresChart').getContext('2d');
            
            if (topCarregadoresChart) {
                topCarregadoresChart.destroy();
            }
            
            topCarregadoresChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topCarregadores.map(f => f.nome),
                    datasets: [{
                        label: 'Carregamentos Participados',
                        data: topCarregadores.map(f => f.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Funcionário'
                            }
                        }
                    }
                }
            });
        }

        // Função para esconder todos os formulários de operação
        function hideAllForms() {
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('formAddFuncionarioContainer').style.display = 'none';
            document.getElementById('formPausarContainer').style.display = 'none';
        }

        // Gera um código único para o funcionário com prefixo da unidade
        function gerarCodigoFuncionario() {
            const prefixo = `${unidadeAtual}-EO-`;
            const randomPart = Math.floor(10000 + Math.random() * 90000);
            return prefixo + randomPart;
        }

        // Gera QR Code para o funcionário
        function gerarQRCode(codigo, canvasId = 'qrCodeCanvas') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            QRCode.toCanvas(canvas, codigo, { width: 200 }, (error) => {
                if (error) console.error('Erro ao gerar QR code:', error);
            });
        }

        // Gera PDF com o código do funcionário
        function gerarPDFCodigo(codigo, nome, cargo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.setFont("helvetica", "bold");
            doc.text('Código do Funcionário', 105, 20, { align: 'center' });

            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text('Nome:', 20, 40);
            doc.text(nome, 50, 40);

            doc.text('Cargo:', 20, 50);
            doc.text(cargo, 50, 50);

            doc.text('Código:', 20, 70);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text(codigo, 50, 70);

            const canvas = document.getElementById('qrCodeCanvas');
            if (canvas) {
                const imgData = canvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', 140, 40, 50, 50);
            }

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const hoje = new Date();
            doc.text(`Emitido em: ${hoje.toLocaleDateString()}`, 20, 130);
            doc.text(`Unidade: ${unidadeAtual}`, 20, 140);

            doc.save(`codigo-funcionario-${codigo}.pdf`);
        }

        // Inicia o scanner de QR code
        function iniciarScanner(inputElement) {
            currentScannerInput = inputElement;
            const video = document.getElementById('video');
            const scanResult = document.getElementById('scanResult');

            document.getElementById('scannerContainer').style.display = 'block';
            scannerActive = true;
            scanResult.style.display = 'none';

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(s) {
                    stream = s;
                    video.srcObject = stream;
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("Erro ao acessar a câmera:", err);
                    alert("Não foi possível acessar a câmera. Verifique as permissões.");
                    pararScanner();
                });
        }

        // Para o scanner de QR code
        function pararScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            scannerActive = false;
            document.getElementById('scannerContainer').style.display = 'none';
            currentScannerInput = null;
        }

        // Processa o vídeo para detectar QR codes
        function tick() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const scanResult = document.getElementById('scanResult');

            if (!scannerActive || !video || video.readyState !== video.HAVE_ENOUGH_DATA) {
                if(scannerActive) requestAnimationFrame(tick);
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                scanResult.textContent = `Código detectado: ${code.data}`;
                scanResult.style.display = 'block';

                if (currentScannerInput) {
                    currentScannerInput.value = code.data;
                }

                setTimeout(pararScanner, 1000);
                return;
            }

            if (scannerActive) {
                requestAnimationFrame(tick);
            }
        }

        function atualizarResumoDocas() {
        // calcula início/fim de hoje
        const hoje = new Date();
        const inicioDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()).getTime();
        const fimDia    = hoje.setHours(23,59,59,999);

        let totalTon = 0;
        let totalCam = 0;

        carregamentosRef
            .orderByChild('fim')
            .startAt(inicioDia)
            .endAt(fimDia)
            .once('value', snapshot => {
            const data = snapshot.val() || {};
            Object.values(data).forEach(c => {
                if (c.finalizado && c.unidade === unidadeAtual) {
                totalCam++;
                totalTon += parseFloat(c.toneladas || 0);
                }
            });

            document.getElementById('resumoToneladas').textContent = totalTon.toFixed(1);
            document.getElementById('resumoCaminhoes').textContent   = totalCam;
            });
        }

        // Verifica a senha do histórico
        function verificarSenhaHistorico() {
            if (typeof SENHA_HISTORICO === 'undefined') {
                alert("Erro: Senha do histórico não configurada. Crie o arquivo key.js.");
                return;
            }

            const senhaDigitada = document.getElementById('inputSenhaHistorico').value;
            if (senhaDigitada === SENHA_HISTORICO) {
                historicoAutenticado = true;
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSenhaHistorico'));
                modal.hide();

                document.getElementById('historicoContent').style.display = 'block';
                document.getElementById('historicoRestrito').style.display = 'none';

                const historicoTab = document.getElementById('historico-tab');
                const historicoPane = document.getElementById('historico');

                document.querySelectorAll('.nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });

                historicoTab.classList.add('active');
                historicoPane.classList.add('show', 'active');

                const hoje = new Date();
                atualizarHistorico(hoje.getMonth() + 1, hoje.getFullYear());
            } else {
                document.getElementById('senhaIncorreta').classList.remove('d-none');
            }
        }

        function atualizarTemposContinuamente() {
            if (intervalos.atualizacaoTempos) {
                clearInterval(intervalos.atualizacaoTempos);
            }

            intervalos.atualizacaoTempos = setInterval(() => {
                Object.keys(carregamentosEmAndamento).forEach(key => {
                    const carregamento = carregamentosEmAndamento[key];
                    if (!carregamento.finalizado) {
                        const tempoDecorrido = Math.floor((new Date().getTime() - carregamento.inicio) / 60000);
                        const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
                            return total + ((pausa.fim || new Date().getTime()) - pausa.inicio);
                        }, 0) / 60000 : 0;
                        const tempoEfetivo = tempoDecorrido - tempoPausado;

                        const elementoOperacao = document.querySelector(`.carregamento-${key} .tempo-decorrido`);
                        if (elementoOperacao) {
                            const tempoRestante = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
                            const tempoRestanteTexto = tempoRestante >= 0 ?
                                `${tempoRestante} minutos restantes` :
                                `Estourou em ${Math.abs(tempoRestante)} minutos`;

                            let pausaTexto = '';
                            if (carregamento.pausado) {
                                pausaTexto = '<br><span class="badge paused-badge">PAUSADO</span>';
                            } else if (tempoPausado > 0) {
                                pausaTexto = `<br><small>Tempo pausado: ${Math.floor(tempoPausado)} min</small>`;
                            }

                            elementoOperacao.innerHTML = `Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoDecorrido} min total)<br>Tempo Restante (2:20h): ${tempoRestanteTexto}${pausaTexto}`;

                            elementoOperacao.className = 'tempo-decorrido ' +
                                (tempoEfetivo > 120 ? 'time-critical' :
                                 tempoEfetivo > 90 ? 'time-warning' :
                                 'time-normal');
                        }
                    }
                });

                const docas = document.querySelectorAll('.doca-container');
                docas.forEach(doca => {
                    const inicio = doca.dataset.inicio;
                    if (inicio) {
                        const tempo = Math.floor((new Date().getTime() - parseInt(inicio)) / 60000);
                        const elemento = doca.querySelector('.tempo-doca');
                        if (elemento) {
                            elemento.textContent = `${tempo}`;
                        }
                    }
                });
            }, 1000);
        }

        // Busca um funcionário pelo ID
        function buscarFuncionario(id, mostrarModal = false) {
            return new Promise((resolve, reject) => {
                funcionariosRef.child(id).once('value', (snapshot) => {
                    const funcionario = snapshot.val();

                    if (!funcionario) {
                        if (mostrarModal) {
                            alert('Funcionário não encontrado!');
                        }
                        reject('Funcionário não encontrado');
                        return;
                    }

                    if (mostrarModal) {
                        mostrarDetalhesFuncionario(id, funcionario);
                    }

                    resolve(funcionario);
                });
            });
        }

        // Mostra os detalhes do funcionário em um modal
        function mostrarDetalhesFuncionario(id, funcionario) {
            carregamentosRef.orderByChild('inicio').once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                const carregamentosFuncionario = Object.entries(carregamentos)
                    .filter(([key, c]) => c.participantes && c.participantes[id])
                    .map(([key, c]) => ({ key, ...c }));

                carregamentosFuncionario.sort((a, b) => (b.inicio || 0) - (a.inicio || 0));

                let html = `
                    <div class="row">
                        <div class="col-md-4">
                            <h4><span class="codigo-funcionario">${id}</span></h4>
                            <p><strong>Nome:</strong> ${funcionario.nome || 'Não informado'}</p>
                            <p><strong>Cargo:</strong> ${funcionario.cargo || 'Não informado'}</p>
                            <p><strong>Unidade:</strong> ${funcionario.unidade || 'Não informado'}</p>
                            <p><strong>Total de Carregamentos Participados:</strong> ${carregamentosFuncionario.length}</p>
                            <div class="mt-3">
                                <canvas id="qrCodeModal"></canvas>
                            </div>
                            <div class="mt-3">
                                <button id="btnDeletarFuncionario" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Apagar Funcionário
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>Últimos Carregamentos Participados</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>DT</th>
                                            <th>Tempo Total Carreg.</th>
                                            <th>Tempo Participação</th>
                                            <th>Status</th>
                                            <th>Doca</th>
                                            <th>Valor Est. Ganho</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;

                const carregamentosExibir = carregamentosFuncionario.slice(0, 10);

                carregamentosExibir.forEach(carregamento => {
                    const inicioCarregamento = carregamento.inicio ? new Date(carregamento.inicio).toLocaleDateString() : 'N/A';
                    const fimCarregamento = carregamento.fim ? new Date(carregamento.fim) : null;
                    const tempoTotalCarregamento = fimCarregamento ? `${((fimCarregamento.getTime() - carregamento.inicio) / 60000).toFixed(2)} min` : 'Em andamento';

                    const participacao = carregamento.participantes[id];
                    const entrada = new Date(participacao.entrada);
                    const saida = participacao.saida ? new Date(participacao.saida) : (carregamento.finalizado ? fimCarregamento : new Date());
                    const tempoParticipacao = `${((saida.getTime() - entrada.getTime()) / 60000).toFixed(2)} min`;

                    const status = carregamento.finalizado ? 'Finalizado' : 'Em andamento';
                    const doca = carregamento.doca || 'N/A';
                    const valorGanho = calcularValorParcial(participacao.entrada, participacao.saida, carregamento.inicio, carregamento.fim);

                    html += `
                        <tr>
                            <td>${inicioCarregamento}</td>
                            <td>${carregamento.placa || 'N/A'}</td>
                            <td>${tempoTotalCarregamento}</td>
                            <td>${tempoParticipacao}</td>
                            <td>${status}</td>
                            <td>${doca}</td>
                            <td>R$ ${valorGanho.toFixed(2).replace('.', ',')}</td>
                        </tr>
                    `;
                });

                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('modalFuncionarioTitle').textContent = `Detalhes: ${funcionario.nome || id}`;
                document.getElementById('modalFuncionarioBody').innerHTML = html;

                gerarQRCode(id, 'qrCodeModal');

                const modal = new bootstrap.Modal(document.getElementById('modalFuncionario'));
                modal.show();

                document.getElementById('btnDeletarFuncionario').addEventListener('click', function() {
                    if (confirm(`Tem certeza que deseja apagar o funcionário ${funcionario.nome} (${id})? Esta ação não pode ser desfeita!`)) {
                        funcionariosRef.child(id).remove()
                            .then(() => {
                                alert('Funcionário apagado com sucesso!');
                                modal.hide();
                            })
                            .catch(error => {
                                alert('Erro ao apagar funcionário: ' + error.message);
                            });
                    }
                });
            });
        }

        // Calcula o valor parcial ganho por um funcionário em um carregamento
        function calcularValorParcial(entradaFuncionario, saidaFuncionario, inicioCarregamento, fimCarregamento) {
            const inicio = inicioCarregamento;
            const fim = fimCarregamento || new Date().getTime();

            const tempoTotalCarregamentoMs = fim - inicio;
            const tempoPermanenciaFuncionarioMs = (saidaFuncionario || fim) - entradaFuncionario;

            if (tempoTotalCarregamentoMs <= 0) {
                return 0;
            }

            const proporcaoTempo = tempoPermanenciaFuncionarioMs / tempoTotalCarregamentoMs;
            let valorGanho = proporcaoTempo * VALOR_POR_COLABORADOR_POR_CARREGAMENTO;
            valorGanho = Math.min(VALOR_POR_COLABORADOR_POR_CARREGAMENTO, valorGanho);
            return Math.max(0, valorGanho);
        }

        // Função para remover um funcionário de um carregamento em andamento
        function removerFuncionarioDeCarregamento(funcionarioId, carregamentoKey, timestampSaida) {
            return new Promise((resolve, reject) => {
                carregamentosRef.child(carregamentoKey).once('value', (snapshot) => {
                    const carregamento = snapshot.val();

                    if (!carregamento || carregamento.finalizado || !carregamento.participantes || !carregamento.participantes[funcionarioId] || carregamento.participantes[funcionarioId].saida) {
                        resolve();
                        return;
                    }

                    const numParticipantesAtivos = Object.values(carregamento.participantes).filter(p => !p.saida).length;

                    if (numParticipantesAtivos <= 1 && carregamento.participantes[funcionarioId] && !carregamento.participantes[funcionarioId].saida) {
                        reject(`Não é possível remover o último funcionário (${carregamento.participantes[funcionarioId].nome || funcionarioId}) de um carregamento em andamento.`);
                        return;
                    }

                    const entrada = carregamento.participantes[funcionarioId].entrada;
                    const valorParcial = calcularValorParcial(entrada, timestampSaida, carregamento.inicio, timestampSaida);

                    const updates = {};
                    updates[`participantes/${funcionarioId}/saida`] = timestampSaida;

                    carregamentosRef.child(carregamentoKey).update(updates)
                        .then(() => {
                            console.log(`Funcionário ${funcionarioId} removido de ${carregamentoKey}. Valor parcial calculado: R$ ${valorParcial.toFixed(2)}`);
                            resolve();
                        })
                        .catch(error => {
                            console.error("Erro ao remover funcionário e calcular parcial:", error);
                            reject("Erro ao remover funcionário e calcular parcial.");
                        });
                });
            });
        }

        // Busca todos os carregamentos em andamento de um ou mais funcionários
        function buscarCarregamentosEmAndamentoPorFuncionarios(funcionarioIds) {
            return new Promise((resolve, reject) => {
                carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
                    const carregamentos = snapshot.val() || {};
                    const carregamentosEncontrados = [];

                    Object.entries(carregamentos).forEach(([key, carregamento]) => {
                        if (carregamento.participantes) {
                            const participantesNoCarregamento = Object.keys(carregamento.participantes);
                            const anyMatch = funcionarioIds.some(id => participantesNoCarregamento.includes(id) && carregamento.participantes[id] && !carregamento.participantes[id].saida);

                            if (anyMatch) {
                                carregamentosEncontrados.push({ key, ...carregamento });
                            }
                        }
                    });
                    resolve(carregamentosEncontrados);
                }, reject);
            });
        }

        // Remove funcionários de carregamentos anteriores antes de iniciar/adicionar
        function removerFuncionariosDeCarregamentosAnteriores(funcionarioIds) {
            const timestampSaida = new Date().getTime();
            const promises = [];

            return buscarCarregamentosEmAndamentoPorFuncionarios(funcionarioIds)
                .then(carregamentosAnteriores => {
                    carregamentosAnteriores.forEach(carregamento => {
                        funcionarioIds.forEach(id => {
                            if (carregamento.participantes && carregamento.participantes[id] && !carregamento.participantes[id].saida) {
                                promises.push(removerFuncionarioDeCarregamento(id, carregamento.key, timestampSaida));
                            }
                        });
                    });
                    return Promise.all(promises);
                });
        }

        // Inicia um novo carregamento
        function iniciarCarregamento() {
            const funcionarioInputs = document.querySelectorAll('#carregadoresContainer .funcionario-input');
            const todosParticipantesIds = Array.from(funcionarioInputs)
                .map(input => input.value.trim())
                .filter(id => id);

            const placa = document.getElementById('placaCaminhao').value.trim().toUpperCase();
            const doca = document.getElementById('docaNumero').value;
            const armagens = $('#armagens').val() || [];

            if (todosParticipantesIds.length === 0 || !placa || !doca || armagens.length === 0) {
                alert('Preencha pelo menos um funcionário, DT, Doca e selecione as armagens!');
                return;
            }

            const timestampEntrada = new Date().getTime();
            let funcionariosComNome = {};

            const buscaFuncionariosPromises = todosParticipantesIds.map(id =>
                buscarFuncionario(id)
                    .then(func => {
                        funcionariosComNome[id] = func.nome || id;
                        return func;
                    })
                    .catch(() => {
                        alert(`Funcionário ${id} não encontrado! Verifique o código.`);
                        throw new Error(`Funcionário ${id} não encontrado`);
                    })
            );

            Promise.all(buscaFuncionariosPromises)
                .then(() => {
                    return removerFuncionariosDeCarregamentosAnteriores(todosParticipantesIds);
                })
                .then(() => {
                    return docasRef.child(doca).once('value');
                })
                .then((snapshot) => {
                    const docaStatus = snapshot.val();

                    if (docaStatus && docaStatus.ocupada) {
                        alert(`Doca ${doca} já está ocupada!`);
                        throw new Error('Doca ocupada');
                    }

                    const participantes = {};
                    todosParticipantesIds.forEach(id => {
                        participantes[id] = {
                            nome: funcionariosComNome[id],
                            entrada: timestampEntrada,
                            saida: null
                        };
                    });

                    const carregamento = {
                        placa,
                        doca,
                        inicio: timestampEntrada,
                        fim: null,
                        finalizado: false,
                        participantes: participantes,
                        armagens: armagens,
                        unidade: unidadeAtual,
                        pausado: false,
                        pausas: []
                    };

                    const newKey = carregamentosRef.push().key;
                    return carregamentosRef.child(newKey).set(carregamento)
                        .then(() => {
                            return docasRef.child(doca).set({
                                ocupada: true,
                                placa,
                                inicio: carregamento.inicio
                            });
                        });
                })
                .then(() => {
                    document.getElementById('formContainer').style.display = 'none';
                    document.querySelectorAll('.funcionario-input').forEach(input => input.value = '');
                    $('#armagens').val(null).trigger('change');
                    const carregadoresContainer = document.getElementById('carregadoresContainer');
                    while (carregadoresContainer.children.length > 1) {
                        carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                    }

                    alert('Carregamento iniciado com sucesso!');
                })
                .catch((error) => {
                    if (error.message !== 'Doca ocupada' && !error.message.startsWith('Funcionário')) {
                        console.error("Erro ao iniciar carregamento:", error);
                        alert('Erro ao iniciar carregamento.');
                    }
                });
        }

        // Finaliza um carregamento
        function finalizarCarregamento() {
            const funcionarioInputs = document.querySelectorAll('#carregadoresContainer .funcionario-input');
            const funcionarioId = funcionarioInputs[0].value.trim();
            const mixMaterial = document.getElementById('mixMaterial').value.trim();
            const toneladas = document.getElementById('toneladas').value.trim();

            if (!funcionarioId || !mixMaterial || !toneladas) {
                alert('Informe o código do funcionário, a quantidade de mix de material e as toneladas!');
                return;
            }

            carregamentosRef.orderByChild('finalizado').equalTo(false)
                .once('value', (snapshot) => {
                    const carregamentos = snapshot.val() || {};
                    let carregamentoEmAndamento = null;
                    let carregamentoKey = null;

                    Object.entries(carregamentos).forEach(([key, c]) => {
                        if (c.participantes && c.participantes[funcionarioId] && !c.participantes[funcionarioId].saida) {
                            carregamentoEmAndamento = c;
                            carregamentoKey = key;
                            return false;
                        }
                    });

                    if (carregamentoEmAndamento && carregamentoKey) {
                        if (!confirm(`Tem certeza que deseja finalizar o carregamento DT: ${carregamentoEmAndamento.placa || 'N/A'} na Doca: ${carregamentoEmAndamento.doca || 'N/A'}?`)) {
                            return;
                        }
                        finalizarCarregamentoFirebase(carregamentoKey, carregamentoEmAndamento, mixMaterial, toneladas);
                    } else {
                        alert('Nenhum carregamento em andamento encontrado para este funcionário!');
                        funcionarioInputs[0].value = '';
                    }
                });
        }

        // Função auxiliar para finalizar no Firebase
        function finalizarCarregamentoFirebase(key, carregamento, mixMaterial, toneladas) {
            const timestampFim = new Date().getTime();
            const updates = {
                fim: timestampFim,
                finalizado: true,
                mixMaterial: parseInt(mixMaterial),
                toneladas: parseFloat(toneladas)
            };

            if (carregamento.participantes) {
                Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
                    if (!participacao.saida) {
                        updates[`participantes/${id}/saida`] = timestampFim;
                    }
                });
            }

            carregamentosRef.child(key).update(updates)
                .then(() => {
                    if (carregamento.doca) {
                        docasRef.child(carregamento.doca).update({
                            ocupada: false,
                            placa: '',
                            inicio: null
                        });
                    }

                    document.getElementById('formContainer').style.display = 'none';
                    document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                    document.getElementById('mixMaterial').value = '';
                    document.getElementById('toneladas').value = '';
                    const carregadoresContainer = document.getElementById('carregadoresContainer');
                    while (carregadoresContainer.children.length > 1) {
                        carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                    }

                    // Atualiza o dashboard completo após finalizar um carregamento
                    atualizarDashboardCompleto();

                    alert('Carregamento finalizado com sucesso!');
                })
                .catch(error => {
                    console.error("Erro ao finalizar carregamento:", error);
                    alert('Erro ao finalizar carregamento.');
                });
        }

        // Preenche o select de carregamentos em andamento
        function preencherSelectCarregamentos() {
            const select = document.getElementById('carregamentoDestino');
            select.innerHTML = '<option value="">Selecione um carregamento em andamento</option>';

            carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                Object.entries(carregamentos).forEach(([key, carregamento]) => {
                    if (carregamento.unidade === unidadeAtual) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `Doca ${carregamento.doca || 'N/A'} - DT ${carregamento.placa || 'N/A'}`;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Preenche o select de carregamentos para pausar/retomar
        function preencherSelectCarregamentosPausar() {
            const select = document.getElementById('carregamentoPausar');
            select.innerHTML = '<option value="">Selecione um carregamento em andamento</option>';

            carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                Object.entries(carregamentos).forEach(([key, carregamento]) => {
                    if (carregamento.unidade === unidadeAtual) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `Doca ${carregamento.doca || 'N/A'} - DT ${carregamento.placa || 'N/A'} ${carregamento.pausado ? '(PAUSADO)' : ''}`;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Pausa ou retoma um carregamento
        function pausarRetomarCarregamento() {
            const funcionarioId = document.getElementById('pausarFuncionarioId').value.trim();
            const carregamentoKey = document.getElementById('carregamentoPausar').value;
            const acao = document.getElementById('acaoPausar').value;

            if (!funcionarioId || !carregamentoKey) {
                alert('Informe o funcionário e selecione o carregamento!');
                return;
            }

            carregamentosRef.child(carregamentoKey).once('value', (snapshot) => {
                const carregamento = snapshot.val();

                if (!carregamento || carregamento.finalizado) {
                    alert('Carregamento selecionado inválido ou já finalizado.');
                    return;
                }

                if (!carregamento.participantes || !carregamento.participantes[funcionarioId] || carregamento.participantes[funcionarioId].saida) {
                    alert('Este funcionário não está participando ativamente deste carregamento.');
                    return;
                }

                const updates = {};
                const agora = new Date().getTime();

                if (acao === 'pausar' || acao === 'pausar_chuva') {
                    if (carregamento.pausado) {
                        alert('Este carregamento já está pausado!');
                        return;
                    }
                    
                    updates.pausado = true;
                    updates.pausas = carregamento.pausas || [];
                    updates.pausas.push({
                        inicio: agora,
                        fim: null,
                        motivo: acao === 'pausar' ? 'Horário de almoço' : 'Chuva'
                    });
                } else { // retomar ou retomar_chuva
                    if (!carregamento.pausado) {
                        alert('Este carregamento não está pausado!');
                        return;
                    }
                    
                    updates.pausado = false;
                    updates.pausas = carregamento.pausas || [];
                    const ultimaPausa = updates.pausas[updates.pausas.length - 1];
                    if (ultimaPausa && !ultimaPausa.fim) {
                        ultimaPausa.fim = agora;
                    }
                }

                carregamentosRef.child(carregamentoKey).update(updates)
                    .then(() => {
                        alert(`Carregamento ${acao === 'pausar' || acao === 'pausar_chuva' ? 'pausado' : 'retomado'} com sucesso!`);
                        hideAllForms();
                        document.getElementById('pausarFuncionarioId').value = '';
                        document.getElementById('carregamentoPausar').value = '';
                    })
                    .catch(error => {
                        console.error("Erro ao pausar/retomar carregamento:", error);
                        alert('Erro ao pausar/retomar carregamento.');
                    });
            });
        }

        // Adiciona um funcionário a um carregamento existente
        function addFuncionarioToCarregamento() {
            const funcionarioId = document.getElementById('addFuncionarioId').value.trim();
            const carregamentoKey = document.getElementById('carregamentoDestino').value;

            if (!funcionarioId || !carregamentoKey) {
                alert('Informe o funcionário e selecione o carregamento!');
                return;
            }

            const timestampEntrada = new Date().getTime();
            let funcionarioNome = funcionarioId;

            buscarFuncionario(funcionarioId)
                .then(func => {
                    funcionarioNome = func.nome || funcionarioId;
                    return removerFuncionariosDeCarregamentosAnteriores([funcionarioId]);
                })
                .then(() => {
                    return carregamentosRef.child(carregamentoKey).once('value');
                })
                .then(snapshot => {
                    const carregamento = snapshot.val();

                    if (!carregamento || carregamento.finalizado) {
                        alert('Carregamento selecionado inválido ou já finalizado.');
                        return;
                    }

                    if (carregamento.participantes && carregamento.participantes[funcionarioId] && !carregamento.participantes[funcionarioId].saida) {
                        alert('Este funcionário já está participando deste carregamento.');
                        return;
                    }

                    const updates = {};
                    updates[`participantes/${funcionarioId}`] = {
                        nome: funcionarioNome,
                        entrada: timestampEntrada,
                        saida: null
                    };

                    return carregamentosRef.child(carregamentoKey).update(updates);
                })
                .then(() => {
                    alert('Funcionário adicionado ao carregamento com sucesso!');
                    hideAllForms();
                    document.getElementById('addFuncionarioId').value = '';
                    document.getElementById('carregamentoDestino').value = '';
                })
                .catch(error => {
                    console.error("Erro ao adicionar funcionário ao carregamento:", error);
                    if (typeof error === 'string' && error.startsWith('Não é possível remover o último funcionário')) {
                        alert(error);
                    } else {
                        alert('Erro ao adicionar funcionário ao carregamento.');
                    }
                });
        }

        // Remove um funcionário de um carregamento em andamento
        function handleRemoveFuncionario(event) {
            const button = event.target.closest('.btn-remove-funcionario');
            const carregamentoKey = button.dataset.carregamentoKey;
            const funcionarioId = button.dataset.funcionarioId;
            const funcionarioNome = button.dataset.funcionarioNome;

            const timestampSaida = new Date().getTime();

            removerFuncionarioDeCarregamento(funcionarioId, carregamentoKey, timestampSaida)
                .then(() => {
                    alert(`${funcionarioNome} removido do carregamento.`);
                })
                .catch(error => {
                    console.error("Erro ao remover funcionário:", error);
                    if (typeof error === 'string') {
                        alert(error);
                    } else {
                        alert('Erro ao remover funcionário.');
                    }
                });
        }

        // Atualiza o dashboard em tempo real
        function atualizarDashboard() {
            carregamentosRef.orderByChild('finalizado').equalTo(false).on('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                carregamentosEmAndamento = carregamentos;

                let operacaoHtml = '';
                Object.entries(carregamentos).forEach(([key, carregamento]) => {
                    if (carregamento.unidade === unidadeAtual) {
                        const tempoDecorrido = Math.floor((new Date().getTime() - carregamento.inicio) / 60000);
                        const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
                            return total + ((pausa.fim || new Date().getTime()) - pausa.inicio);
                        }, 0) / 60000 : 0;
                        const tempoEfetivo = tempoDecorrido - tempoPausado;

                        let tempoClass = 'time-normal';
                        if (tempoEfetivo > 120) tempoClass = 'time-critical';
                        else if (tempoEfetivo > 90) tempoClass = 'time-warning';

                        const tempoRestante = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
                        const tempoRestanteTexto = tempoRestante >= 0 ?
                            `${tempoRestante} minutos restantes` :
                            `Estourou em ${Math.abs(tempoRestante)} minutos`;

                        let participantesHtml = '';
                        const participantesAtivos = Object.entries(carregamento.participantes || {})
                            .filter(([id, p]) => !p.saida);

                        if (participantesAtivos.length > 0) {
                            participantesHtml = '<div class="mt-2"><strong>Colaboradores:</strong><ul class="list-unstyled mb-0 carregadores-lista-operacao">';
                            participantesAtivos.forEach(([id, p]) => {
                                participantesHtml += `
                                    <li>
                                        ${p.nome || id}
                                        <button class="btn btn-outline-danger btn-sm btn-remove-funcionario"
                                                data-carregamento-key="${key}"
                                                data-funcionario-id="${id}"
                                                data-funcionario-nome="${p.nome || id}">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </li>
                                `;
                            });
                            participantesHtml += '</ul></div>';
                        }

                        let pausaBadge = '';
                        if (carregamento.pausado) {
                            pausaBadge = '<span class="badge paused-badge">PAUSADO</span>';
                        }

                        operacaoHtml += `
                            <div class="card card-carregamento em-andamento mb-2 carregamento-${key} ${carregamento.pausado ? 'paused' : ''}">
                                <div class="card-body">
                                    <h6 class="card-title">DT: ${carregamento.placa || 'N/A'} ${pausaBadge}</h6>
                                    <p class="card-text">Doca: ${carregamento.doca || 'N/A'}</p>
                                    ${participantesHtml}
                                    <p class="card-text tempo-decorrido ${tempoClass}">
                                       Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoDecorrido} min total)<br>
                                       Tempo Restante (2:20h): ${tempoRestanteTexto}
                                    </p>
                                    <p class="card-text mb-0"><small>Início: ${new Date(carregamento.inicio).toLocaleTimeString()}</small></p>
                                    ${carregamento.armagens ? `<p class="card-text mb-0"><small>Armagens: ${carregamento.armagens.join(', ')}</small></p>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });

                document.getElementById('carregamentosAndamento').innerHTML = operacaoHtml || '<p>Nenhum carregamento em andamento no momento.</p>';

                document.querySelectorAll('.btn-remove-funcionario').forEach(btn => {
                    btn.removeEventListener('click', handleRemoveFuncionario);
                    btn.addEventListener('click', handleRemoveFuncionario);
                });

                let dashboardHtml = '';
                const funcionariosEmAcao = {};

                Object.keys(carregamentos).forEach(key => {
                    const carregamento = carregamentos[key];
                    if (carregamento.unidade === unidadeAtual) {
                        const tempoDecorrido = Math.floor((new Date().getTime() - carregamento.inicio) / 60000);
                        const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
                            return total + ((pausa.fim || new Date().getTime()) - pausa.inicio);
                        }, 0) / 60000 : 0;
                        const tempoEfetivo = tempoDecorrido - tempoPausado;

                        const porcentagem = Math.min(100, Math.max(0, (tempoEfetivo / TEMPO_LIMITE_MINUTOS) * 100));

                        let progressClass = 'bg-success';
                        if (porcentagem > 75) progressClass = 'bg-warning';
                        if (porcentagem >= 100) progressClass = 'bg-danger';

                        const tempoRestante = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
                        const tempoRestanteTexto = tempoRestante >= 0 ?
                            `${tempoRestante} min restantes` :
                            `Estourou em ${Math.abs(tempoRestante)} min`;

                        let pausaBadge = '';
                        if (carregamento.pausado) {
                            pausaBadge = '<span class="badge paused-badge">PAUSADO</span>';
                        }

                        dashboardHtml += `
                            <div class="card mb-3 ${carregamento.pausado ? 'paused' : ''}">
                                <div class="card-body">
                                    <h6>DT: ${carregamento.placa || 'N/A'} ${pausaBadge}</h6>
                                    <p>Doca: ${carregamento.doca || 'N/A'}</p>
                                    <div class="progress progress-bar-tempo">
                                        <div class="progress-bar ${progressClass}"
                                             role="progressbar"
                                             style="width: ${porcentagem}%"
                                             aria-valuenow="${porcentagem}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small>Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoRestanteTexto})</small>
                                    ${carregamento.armagens ? `<p class="mb-0"><small>Armagens: ${carregamento.armagens.join(', ')}</small></p>` : ''}
                                </div>
                            </div>
                        `;

                        if (carregamento.participantes) {
                            Object.entries(carregamento.participantes)
                                .filter(([id, p]) => !p.saida)
                                .forEach(([id, p]) => {
                                    funcionariosEmAcao[id] = (funcionariosEmAcao[id] || 0) + 1;
                                });
                        }
                    }
                });

                document.getElementById('dashboardCarregamentos').innerHTML = dashboardHtml || '<p>Nenhum carregamento em andamento</p>';

                const totalCarregamentos = Object.values(carregamentos).filter(c => c.unidade === unidadeAtual).length;
                document.getElementById('totalCarregamentosHoje').textContent = totalCarregamentos;

                const funcionariosEmAcaoIds = Object.keys(funcionariosEmAcao);
                if (funcionariosEmAcaoIds.length > 0) {
                    const promises = funcionariosEmAcaoIds.map(id => buscarFuncionario(id).then(f => ({ id, nome: f.nome || id })).catch(() => ({ id, nome: id })));
                    Promise.all(promises).then(funcionariosComNome => {
                        let funcionariosHtml = '';
                        funcionariosComNome.forEach(func => {
                            funcionariosHtml += `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong>${func.nome}</strong>
                                        <small class="text-muted d-block">${func.id}</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">${funcionariosEmAcao[func.id]} carreg.</span>
                                </div>
                            `;
                        });
                        document.getElementById('dashboardFuncionarios').innerHTML = funcionariosHtml;
                    });
                } else {
                    document.getElementById('dashboardFuncionarios').innerHTML = '<p>Nenhum funcionário em ação no momento</p>';
                }
            });

            docasRef.on('value', snapshot => {
            const docas = snapshot.val() || {};
            const container = document.getElementById('docasContainer');
            container.innerHTML = '';

            // 1) monta array de docas de 1 a 11
            const arr = [];
            for (let i = 1; i <= 11; i++) {
                arr.push({ num: i, info: docas[i] || { ocupada: false } });
            }

            // 2) separa ocupadas e livres
            const ocupadas = arr.filter(d => d.info.ocupada);
            const livres   = arr.filter(d => !d.info.ocupada);

            // 3) concatena para exibir ocupadas primeiro
            const ordenadas = [...ocupadas, ...livres];

            // constantes de tempo
            const LIMITE_MIN = 140;
            const AMARELO    = 40;
            const VERMELHO   = 20;

            // 4) renderiza cada doca
            ordenadas.forEach(doca => {
                const i            = doca.num;
                const info         = doca.info;
                const ocupadaClass = info.ocupada ? 'doca-ocupada' : '';
                const statusText   = info.ocupada ? 'Ocupada 🚚💨' : 'Livre 🚛';
                const statusClass  = info.ocupada ? 'text-danger' : 'text-success';
                const placa        = info.placa || '';
                const inicioMs     = info.inicio || 0;
                const inicioStr    = inicioMs ? new Date(inicioMs).toLocaleTimeString() : '';
                const tempoDec     = inicioMs ? Math.floor((Date.now() - inicioMs) / 60000) : 0;

                // calcula restante
                const restanteMin = LIMITE_MIN - tempoDec;
                const sinal       = restanteMin < 0 ? '-' : '';
                const absRest     = Math.abs(restanteMin);
                const h           = Math.floor(absRest / 60);
                const m           = absRest % 60;
                const restanteStr = `${sinal}${h}h${m.toString().padStart(2,'0')}min`;

                // escolhe cor da barra
                let barraClass = 'bg-success';
                if (restanteMin <= VERMELHO) barraClass = 'bg-danger';
                else if (restanteMin <= AMARELO) barraClass = 'bg-warning';

                // calcula % preenchido
                const pct = Math.min(100, (tempoDec / LIMITE_MIN) * 100);

                // injeta HTML
                container.innerHTML += `
                <div class="col-md-4">
                    <div 
                    class="doca-container ${ocupadaClass} doca-${i}" 
                    data-inicio="${inicioMs}"
                    >
                    <div class="doca-header">Doca ${i}</div>
                    <p class="mb-1">
                        <strong>Status:</strong>
                        <span class="${statusClass}">${statusText}</span>
                    </p>
                    ${info.ocupada ? `
                        <p class="mb-1"><strong>Colaboradores:</strong></p>
                        <div class="carregadores-nomes">Carregando nomes...</div>
                        <p class="mb-1"><strong>DT:</strong> ${placa}</p>
                        <p class="mb-1"><strong>Início:</strong> ${inicioStr}</p>
                        <p class="mb-1"><strong>Tempo:</strong> ${tempoDec} min</p>
                        <p class="mb-1">
                        <strong>Tempo Restante:</strong> 
                        <span class="tempo-barra-${i}">${restanteStr}</span>
                        </p>
                        <div class="progress mb-2" style="height:20px">
                        <div
                            id="barraDoca-${i}"
                            class="progress-bar ${barraClass}"
                            role="progressbar"
                            style="width:${pct}%"
                            aria-valuenow="${tempoDec}"
                            aria-valuemin="0"
                            aria-valuemax="${restanteStr}"
                        >
                            <span class="tempo-barra-${i}">${restanteStr}</span>
                        </div>
                        </div>
                    ` : ''}
                    </div>
                </div>
                `;
                
                // 5) se estiver ocupada, busca os carregadores ativos e preenche
                if (info.ocupada) {
                carregamentosRef
                    .orderByChild('doca')
                    .equalTo(i.toString())
                    .once('value', snapCar => {
                    const dados = snapCar.val() || {};
                    // encontra o carregamento não-finalizado
                    const key = Object.keys(dados)
                        .find(k => !dados[k].finalizado);
                    if (!key) return;
                    const participantes = dados[key].participantes || {};
                    const nomes = Object.entries(participantes)
                        .filter(([_, p]) => !p.saida)
                        .map(([_, p]) => p.nome);
                    // injeta nomes
                    const divNomes = document
                        .querySelector(`.doca-${i} .carregadores-nomes`);
                    if (divNomes) divNomes.innerHTML = nomes.join('<br>');
                    });
                }
            });
            atualizarResumoDocas();
            });
        }

        function atualizarBarrasTempo() {
  const limiteMinutos = 140;
  const avisoAmarelo = 40;
  const avisoVermelho = 20;

  for (let i = 1; i <= 11; i++) {
    const barra = document.getElementById(`barraDoca-${i}`);
    const docaDiv = document.querySelector(`.doca-${i}`);
    const tempoSpan = document.querySelector(`.tempo-barra-${i}`);
    if (!barra || !docaDiv || !tempoSpan) continue;

    const inicio = parseInt(docaDiv.dataset.inicio);
    if (!inicio) continue;

    const minutosPassados = Math.floor((Date.now() - inicio) / 60000);
    const restantes = limiteMinutos - minutosPassados;

    // ajusta largura da barra (você já faz algo parecido)
    let pct = (minutosPassados / limiteMinutos) * 100;
    pct = Math.min(Math.max(pct, 0), 100);
    barra.style.width = pct + '%';

    // troca a cor da barra
    if (restantes <= avisoVermelho) {
      barra.className = 'progress-bar bg-danger';
    } else if (restantes <= avisoAmarelo) {
      barra.className = 'progress-bar bg-warning';
    } else {
      barra.className = 'progress-bar bg-success';
    }

    // formata o texto do tempo
    tempoSpan.textContent = restantes >= 0
      ? `${Math.floor(restantes/60)}h${(restantes%60).toString().padStart(2,'0')}min`
      : `-${Math.floor(-restantes/60)}h${(Math.abs(restantes)%60).toString().padStart(2,'0')}min`;

    // aqui você aplica o fundo da doca:
    docaDiv.classList.remove('doca-tempo-verde','doca-tempo-amarelo','doca-tempo-vermelho');
    if (restantes <= avisoVermelho) {
      docaDiv.classList.add('doca-tempo-vermelho');
    } else if (restantes <= avisoAmarelo) {
      docaDiv.classList.add('doca-tempo-amarelo');
    } else {
      docaDiv.classList.add('doca-tempo-verde');
    }
  }
}
setInterval(atualizarBarrasTempo, 1000);

        function formatarTempo(minutos) {
            const horas = Math.floor(minutos / 60);
            const min = minutos % 60;
            return `${horas}h${min.toString().padStart(2, '0')}`;
        }

        setInterval(atualizarBarrasTempo, 1000);

        // Atualiza o ranking na aba Ranking (Pódio)
        function atualizarRankingDashboard() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1;
            const anoAtual = hoje.getFullYear();

            document.getElementById('rankingMesAno').textContent = `Ranking de ${hoje.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}`;
            document.getElementById('podiumContainer').innerHTML = '';
            document.getElementById('rankingEmpty').style.display = 'none';
            document.getElementById('rankingLoading').style.display = 'block';

            carregamentosRef.orderByChild('fim').once('value', (snapshot) => {
                const todosCarregamentos = snapshot.val() || {};
                const carregamentosMes = Object.values(todosCarregamentos)
                    .filter(c => {
                        if (!c.fim) return false;
                        const dataFim = new Date(c.fim);
                        return dataFim.getMonth() + 1 === mesAtual && dataFim.getFullYear() === anoAtual && c.unidade === unidadeAtual;
                    });

                const funcionariosStats = {};

                carregamentosMes.forEach(carregamento => {
                    if (carregamento.participantes) {
                        Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
                            if (participacao.entrada && participacao.saida) {
                                if (!funcionariosStats[id]) {
                                    funcionariosStats[id] = { count: 0, nome: participacao.nome || id };
                                }
                                funcionariosStats[id].count++;
                            }
                        });
                    }
                });

                const ranking = Object.entries(funcionariosStats)
                    .map(([id, stats]) => ({ id, nome: stats.nome, count: stats.count }))
                    .sort((a, b) => b.count - a.count);

                const podiumContainer = document.getElementById('podiumContainer');
                podiumContainer.innerHTML = '';

                if (ranking.length >= 3) {
                    const top3 = ranking.slice(0, 3);

                    podiumContainer.innerHTML += `
                        <div class="podium-step silver">
                            <div class="content">
                                <div class="name">${top3[1].nome}</div>
                                <div class="medal-icon"><i class="bi bi-award-fill medal-silver"></i></div>
                            </div>
                            <div class="base"></div>
                        </div>
                    `;

                    podiumContainer.innerHTML += `
                        <div class="podium-step gold">
                            <div class="content">
                                <div class="name">${top3[0].nome}</div>
                                <div class="medal-icon"><i class="bi bi-award-fill medal-gold"></i></div>
                            </div>
                            <div class="base"></div>
                        </div>
                    `;

                    podiumContainer.innerHTML += `
                        <div class="podium-step bronze">
                            <div class="content">
                                <div class="name">${top3[2].nome}</div>
                                <div class="medal-icon"><i class="bi bi-award-fill medal-bronze"></i></div>
                            </div>
                            <div class="base"></div>
                        </div>
                    `;
                } else {
                    document.getElementById('rankingEmpty').style.display = 'block';
                }

                document.getElementById('rankingLoading').style.display = 'none';
            });
        }

        // Atualiza o histórico (chamada após autenticação ou filtro)
        function atualizarHistorico(mes, ano, funcionarioId = null) {
            document.getElementById('tabelaHistorico').innerHTML = `
                <tr>
                    <td colspan="11" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </td>
                </tr>
            `;
            document.getElementById('topFuncionariosHistorico').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="spinner-border text-primary spinner-border-sm" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </td>
                </tr>
            `;

            const startDate = new Date(ano, mes - 1, 1).getTime();
            const endDate = new Date(ano, mes, 0, 23, 59, 59).getTime();

            let query = carregamentosRef.orderByChild('inicio');
            query = query.startAt(startDate).endAt(endDate);

            query.once('value', (snapshot) => {
                const todosCarregamentosNoPeriodo = snapshot.val() || {};
                const carregamentosFinalizadosNoPeriodo = Object.values(todosCarregamentosNoPeriodo)
                    .filter(c => c.finalizado && c.fim && c.unidade === unidadeAtual);

                const carregamentosFiltrados = funcionarioId ?
                    carregamentosFinalizadosNoPeriodo.filter(c => c.participantes && c.participantes[funcionarioId]) :
                    carregamentosFinalizadosNoPeriodo;

                carregamentosFiltrados.sort((a, b) => b.inicio - a.inicio);

                atualizarEstatisticasHistorico(carregamentosFiltrados);
                preencherTabelaHistorico(carregamentosFiltrados);
                atualizarRankingHistorico(carregamentosFiltrados);
            });
        }

        function atualizarEstatisticasHistorico(carregamentosArray) {
            const totalCaminhoes = carregamentosArray.length;
            const tempoTotal = carregamentosArray.reduce((sum, c) => sum + (c.fim - c.inicio), 0);
            const mediaTempo = totalCaminhoes > 0 ? (tempoTotal / totalCaminhoes / 60000).toFixed(2) : 0;

            let valorTotalEstimado = 0;
            carregamentosArray.forEach(carregamento => {
                if (carregamento.participantes) {
                    Object.values(carregamento.participantes).forEach(participacao => {
                        if (participacao.entrada && participacao.saida) {
                            valorTotalEstimado += calcularValorParcial(participacao.entrada, participacao.saida, carregamento.inicio, carregamento.fim);
                        }
                    });
                }
            });

            document.getElementById('totalCaminhoes').textContent = totalCaminhoes;
            document.getElementById('mediaTempo').textContent = `${mediaTempo} min`;
            document.getElementById('valorTotal').textContent = `R$ ${valorTotalEstimado.toFixed(2).replace('.', ',')}`;
        }

        // Atualiza o ranking completo na aba Histórico
        function atualizarRankingHistorico(carregamentos) {
            const funcionariosStats = {};

            carregamentos.forEach(carregamento => {
                if (carregamento.participantes) {
                    Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
                        if (participacao.entrada && participacao.saida) {
                            if (!funcionariosStats[id]) {
                                funcionariosStats[id] = {
                                    count: 0,
                                    tempoTotal: 0,
                                    nome: participacao.nome || id,
                                    valorTotalGanho: 0
                                };
                            }
                            funcionariosStats[id].count++;
                            funcionariosStats[id].tempoTotal += (participacao.saida - participacao.entrada);
                            funcionariosStats[id].valorTotalGanho += calcularValorParcial(participacao.entrada, participacao.saida, carregamento.inicio, carregamento.fim);
                        }
                    });
                }
            });

            const ranking = Object.entries(funcionariosStats)
                .map(([id, stats]) => ({
                    id,
                    nome: stats.nome,
                    count: stats.count,
                    tempoMedio: stats.count > 0 ? (stats.tempoTotal / stats.count / 60000).toFixed(2) : 0,
                    valor: stats.valorTotalGanho.toFixed(2)
                }))
                .sort((a, b) => b.count - a.count);

            let topFuncionariosHtml = '';
            ranking.slice(0, 20).forEach((func, index) => {
                topFuncionariosHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${func.nome} <small class="text-muted">${func.id}</small></td>
                        <td>${func.count}</td>
                        <td>${func.tempoMedio} min</td>
                        <td>R$ ${func.valor.replace('.', ',')}</td>
                    </tr>
                `;
            });

            document.getElementById('topFuncionariosHistorico').innerHTML = topFuncionariosHtml || '<tr><td colspan="5" class="text-center">Sem dados para ranking no período</td></tr>';
        }

        // Função auxiliar para preencher a tabela de histórico
        function preencherTabelaHistorico(carregamentosArray) {
            let historicoHtml = '';

            if (carregamentosArray.length === 0) {
                document.getElementById('tabelaHistorico').innerHTML = '<tr><td colspan="11" class="text-center">Nenhum registro encontrado para o período/filtro</td></tr>';
                return;
            }

            carregamentosArray.forEach((carregamento) => {
                const inicio = new Date(carregamento.inicio);
                const fim = carregamento.fim ? new Date(carregamento.fim) : null;
                const tempoTotalCarregamento = fim ? `${((fim - inicio) / 60000).toFixed(2)} min` : 'N/A';

                // Calcula tempo total de pausas
                const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
                    return total + ((pausa.fim || carregamento.fim) - pausa.inicio);
                }, 0) / 60000 : 0;

                // Encontra o funcionário principal (primeiro a entrar)
                let funcionarioPrincipal = 'N/A';
                if (carregamento.participantes) {
                    const participantes = Object.entries(carregamento.participantes)
                        .map(([id, p]) => ({ id, nome: p.nome || id, entrada: p.entrada }));
                    
                    participantes.sort((a, b) => a.entrada - b.entrada);
                    if (participantes.length > 0) {
                        funcionarioPrincipal = participantes[0].nome;
                    }
                }

                historicoHtml += `
                    <tr>
                        <td>${inicio.toLocaleDateString()}</td>
                        <td>${carregamento.placa || 'N/A'}</td>
                        <td>${funcionarioPrincipal}</td>
                        <td>${inicio.toLocaleTimeString()}</td>
                        <td>${fim ? fim.toLocaleTimeString() : 'N/A'}</td>
                        <td>${tempoTotalCarregamento}</td>
                        <td>${carregamento.doca || 'N/A'}</td>
                        <td>${carregamento.armagens ? carregamento.armagens.join(', ') : 'N/A'}</td>
                        <td>${carregamento.mixMaterial || 'N/A'}</td>
                        <td>${carregamento.toneladas || 'N/A'}</td>
                        <td>${tempoPausado.toFixed(2)} min</td>
                    </tr>
                `;
            });

            document.getElementById('tabelaHistorico').innerHTML = historicoHtml;
        }

        // Login/Seleção de Unidade
        document.getElementById('btnLogin').addEventListener('click', function() {
            const unidade = document.getElementById('unidade').value;
            const senha = document.getElementById('senha').value;

            if (!unidade || !senha) {
                document.getElementById('loginError').textContent = 'Preencha a unidade e a senha!';
                document.getElementById('loginError').classList.remove('d-none');
                return;
            }

            // Verifica a senha (simplificado para exemplo)
            if (senha === '123456') { // Substitua por sua lógica de autenticação
                unidadeAtual = unidade;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('loginError').classList.add('d-none');
                inicializarSistema();
            } else {
                document.getElementById('loginError').textContent = 'Senha incorreta!';
                document.getElementById('loginError').classList.remove('d-none');
            }
        });

        // Botão de logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        });

        // Verifica autenticação
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // Mostra a tela de login/unidade
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            } else {
                // Se já autenticado, mostra a tela de seleção de unidade
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        });
    </script>
</body>
</html>